name: "Release Build"
on:
  release:
    types: [created]
  workflow_dispatch:
    # This allows manual triggering from the GitHub Actions tab

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
          check-latest: true
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Get pnpm store directory
        shell: pwsh
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $env:GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install UPX
        run: |
          choco install upx -y

      - name: Install NSIS
        run: |
          choco install nsis -y
          # Add NSIS to PATH for current session
          $nsisPath = "C:\Program Files (x86)\NSIS"
          echo "$nsisPath" >> $env:GITHUB_PATH

      - name: Install Wails
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Clean build directory
        run: |
          if (Test-Path "build\bin\windows") {
            Remove-Item -Recurse -Force "build\bin\windows"
          }
          New-Item -ItemType Directory -Force -Path "build\bin\windows"

      - name: Build Wails application (amd64)
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: |
          wails build -platform windows/amd64 -upx -nsis -clean
          New-Item -ItemType Directory -Force -Path "build\bin\windows"
          # Move the binary
          if (Test-Path "build\bin\TridUI.exe") {
            Move-Item -Force "build\bin\TridUI.exe" "build\bin\windows\TridUI-win-amd64.exe"
          }
          # Move the installer
          if (Test-Path "build\bin\TridUI-amd64-installer.exe") {
            Move-Item -Force "build\bin\TridUI-amd64-installer.exe" "build\bin\windows\TridUI-win-amd64-installer.exe"
          }

      - name: Build Wails application (arm64)
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: |
          wails build -platform windows/arm64 -nsis
          New-Item -ItemType Directory -Force -Path "build\bin\windows"
          # Move the binary
          if (Test-Path "build\bin\TridUI.exe") {
            Move-Item -Force "build\bin\TridUI.exe" "build\bin\windows\TridUI-win-arm64.exe"
          }
          # Move the installer
          if (Test-Path "build\bin\TridUI-arm64-installer.exe") {
            Move-Item -Force "build\bin\TridUI-arm64-installer.exe" "build\bin\windows\TridUI-win-arm64-installer.exe"
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TridUI-windows
          path: build/bin/windows/*
          retention-days: 90

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
          check-latest: true
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Wails
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Clean build directory
        run: |
          rm -rf build/bin/darwin
          mkdir -p build/bin/darwin

      - name: Build Wails application (universal)
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: |
          wails build -platform darwin/universal -clean
          mkdir -p build/bin/darwin
          if [ -d "build/bin/TridUI.app" ]; then
            cp -R build/bin/TridUI.app build/bin/darwin/TridUI.app
          fi

      - name: Install create-dmg
        run: |
          brew install create-dmg

      - name: Create DMG and ZIP
        run: |
          # Create ZIP of TridUI.app using ditto (preserves permissions and attributes)
          cd build/bin/darwin
          ditto -c -k --keepParent TridUI.app TridUI-macOS.zip
          cd ../../..
          
          # Use icon from build dir or fall back to repo root
          ICON_PATH="build/appicon.png"
          if [ ! -f "$ICON_PATH" ]; then
            ICON_PATH="icon.png"
          fi
          
          # Create DMG
          create-dmg \
            --volname "TrID UI" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "TridUI.app" 175 190 \
            --hide-extension "TridUI.app" \
            --app-drop-link 425 190 \
            "build/bin/darwin/TridUI-macOS.dmg" \
            "build/bin/darwin/TridUI.app" || echo "DMG creation failed, but ZIP is available"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TridUI-macos
          path: build/bin/darwin/*
          retention-days: 90

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Wails Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libglib2.0-dev \
            libglib2.0-bin \
            libgdk-pixbuf2.0-dev \
            libgirepository1.0-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libatk1.0-dev \
            libatk-bridge2.0-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxdamage-dev \
            libxext-dev \
            libxfixes-dev \
            libxi-dev \
            libxrandr-dev \
            libxrender-dev \
            libxtst-dev \
            libnss3 \
            libasound2t64 \
            upx-ucl
          # Create symlink for webkit2gtk-4.0 compatibility
          sudo ln -sf /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
          check-latest: true
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Wails
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Clean build directory
        run: |
          rm -rf build/bin/linux
          mkdir -p build/bin/linux

      - name: Build Wails application (amd64)
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: |
          wails build -platform linux/amd64 -upx
          mkdir -p build/bin/linux
          if [ -f "build/bin/TridUI" ]; then
            cp "build/bin/TridUI" "build/bin/linux/TridUI-linux-amd64"
            chmod +x "build/bin/linux/TridUI-linux-amd64"
          fi

      - name: Install AppImage dependencies
        run: |
          sudo apt-get install -y libfuse2 file
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          ./appimagetool --appimage-extract
          sudo mv squashfs-root /opt/appimagetool
          sudo ln -s /opt/appimagetool/AppRun /usr/local/bin/appimagetool

      - name: Create AppImage
        run: |
          mkdir -p TridUI.AppDir/usr/bin
          mkdir -p TridUI.AppDir/usr/share/applications
          mkdir -p TridUI.AppDir/usr/share/icons/hicolor/256x256/apps
          
          cp build/bin/linux/TridUI-linux-amd64 TridUI.AppDir/usr/bin/TridUI
          
          cat > TridUI.AppDir/usr/share/applications/TridUI.desktop << 'EOF'
          [Desktop Entry]
          Name=TrID UI
          Exec=TridUI
          Icon=TridUI
          Type=Application
          Categories=Utility;
          Comment=File type identification tool
          Terminal=false
          EOF
          
          if [ -f "icon.png" ]; then
            cp icon.png TridUI.AppDir/usr/share/icons/hicolor/256x256/apps/TridUI.png
            cp icon.png TridUI.AppDir/TridUI.png
          elif [ -f "build/appicon.png" ]; then
            cp build/appicon.png TridUI.AppDir/usr/share/icons/hicolor/256x256/apps/TridUI.png
            cp build/appicon.png TridUI.AppDir/TridUI.png
          fi
          
          cat > TridUI.AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib/:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/TridUI" "$@"
          EOF
          chmod +x TridUI.AppDir/AppRun
          
          cp TridUI.AppDir/usr/share/applications/TridUI.desktop TridUI.AppDir/
          
          ARCH=x86_64 appimagetool --no-appstream TridUI.AppDir build/bin/linux/TridUI-linux-amd64.AppImage

      - name: Install .deb packaging tools
        run: |
          sudo apt-get install -y dpkg-dev fakeroot

      - name: Create .deb package
        run: |
          mkdir -p tridui-deb/DEBIAN
          mkdir -p tridui-deb/usr/bin
          mkdir -p tridui-deb/usr/share/applications
          mkdir -p tridui-deb/usr/share/icons/hicolor/256x256/apps
          mkdir -p tridui-deb/usr/share/icons/hicolor/128x128/apps
          mkdir -p tridui-deb/usr/share/icons/hicolor/64x64/apps
          mkdir -p tridui-deb/usr/share/pixmaps
          mkdir -p tridui-deb/usr/share/doc/tridui
          mkdir -p tridui-deb/usr/share/metainfo
          
          # Copy binary
          cp build/bin/linux/TridUI-linux-amd64 tridui-deb/usr/bin/tridui
          chmod +x tridui-deb/usr/bin/tridui
          
          # Create desktop file with extended info
          cat > tridui-deb/usr/share/applications/tridui.desktop << 'EOF'
          [Desktop Entry]
          Name=TrID UI
          GenericName=File Type Identifier
          Comment=Identify file types using binary signatures with TrID
          Exec=/usr/bin/tridui %F
          Icon=tridui
          Type=Application
          Categories=Utility;System;FileTools;
          Keywords=file;type;identifier;trid;signature;format;analysis;
          Terminal=false
          StartupNotify=true
          StartupWMClass=TridUI
          MimeType=application/octet-stream;
          Actions=About;
          
          [Desktop Action About]
          Name=About TrID UI
          Exec=/usr/bin/tridui --about
          EOF
          
          # Copy icon in multiple sizes
          if [ -f "icon.png" ]; then
            cp icon.png tridui-deb/usr/share/icons/hicolor/256x256/apps/tridui.png
            cp icon.png tridui-deb/usr/share/pixmaps/tridui.png
            # Create smaller versions if ImageMagick is available
            if command -v convert &> /dev/null; then
              convert icon.png -resize 128x128 tridui-deb/usr/share/icons/hicolor/128x128/apps/tridui.png
              convert icon.png -resize 64x64 tridui-deb/usr/share/icons/hicolor/64x64/apps/tridui.png
            fi
          elif [ -f "build/appicon.png" ]; then
            cp build/appicon.png tridui-deb/usr/share/icons/hicolor/256x256/apps/tridui.png
            cp build/appicon.png tridui-deb/usr/share/pixmaps/tridui.png
          fi
          
          # Create AppStream metadata for software centers
          cat > tridui-deb/usr/share/metainfo/com.github.jmcrafter26.tridui.metainfo.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <component type="desktop-application">
            <id>com.github.jmcrafter26.tridui</id>
            <metadata_license>CC0-1.0</metadata_license>
            <project_license>AGPL-3.0-or-later</project_license>
            <name>TrID UI</name>
            <summary>Identify file types using binary signatures</summary>
            <description>
              <p>
                TrID UI is a lightweight desktop application that provides a user-friendly interface for TrID,
                a powerful tool for scanning and analyzing files. With TrID UI, users can easily select or drop
                files to initiate local scans, making it convenient to detect unrecognized file types.
              </p>
              <p>Features:</p>
              <ul>
                <li>Fast native Go-based file scanning</li>
                <li>Accurate file type identification using TrID definitions</li>
                <li>Cross-platform desktop application</li>
                <li>100% local processing - no data leaves your computer</li>
                <li>Modern, intuitive user interface</li>
                <li>Detailed match results with confidence scores</li>
                <li>Drag-and-drop file support</li>
                <li>Automatic definitions updates with one click</li>
                <li>Multi-language support</li>
              </ul>
            </description>
            <launchable type="desktop-id">tridui.desktop</launchable>
            <screenshots>
              <screenshot type="default">
                <image>https://github.com/JMcrafter26/TridUI/blob/main/.github/assets/1.1.0/home.png?raw=true</image>
                <caption>Main interface with drag-and-drop support</caption>
              </screenshot>
              <screenshot>
                <image>https://github.com/JMcrafter26/TridUI/blob/main/.github/assets/1.1.0/scan.png?raw=true</image>
                <caption>File scan results with confidence scores</caption>
              </screenshot>
              <screenshot>
                <image>https://github.com/JMcrafter26/TridUI/blob/main/.github/assets/1.1.0/settings.png?raw=true</image>
                <caption>Settings and automatic updates</caption>
              </screenshot>
            </screenshots>
            <url type="homepage">https://github.com/JMcrafter26/TridUI</url>
            <url type="bugtracker">https://github.com/JMcrafter26/TridUI/issues</url>
            <url type="help">https://github.com/JMcrafter26/TridUI#readme</url>
            <url type="vcs-browser">https://github.com/JMcrafter26/TridUI</url>
            <developer_name>JMcrafter26 (Cufiy)</developer_name>
            <content_rating type="oars-1.1" />
            <releases>
              <release version="1.1.0" date="2025-11-04">
                <description>
                  <p>Latest stable release with enhanced features and improvements.</p>
                </description>
              </release>
            </releases>
            <categories>
              <category>Utility</category>
              <category>System</category>
            </categories>
            <keywords>
              <keyword>file</keyword>
              <keyword>type</keyword>
              <keyword>identifier</keyword>
              <keyword>trid</keyword>
              <keyword>signature</keyword>
              <keyword>format</keyword>
            </keywords>
          </component>
          EOF
          
          # Create copyright file
          cat > tridui-deb/usr/share/doc/tridui/copyright << 'EOF'
          Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
          Upstream-Name: TrID UI
          Upstream-Contact: JMcrafter26 <https://github.com/JMcrafter26>
          Source: https://github.com/JMcrafter26/TridUI
          
          Files: *
          Copyright: 2025 JMcrafter26 (Cufiy)
          License: AGPL-3.0-or-later
          
          License: AGPL-3.0-or-later
           This program is free software: you can redistribute it and/or modify
           it under the terms of the GNU Affero General Public License as published by
           the Free Software Foundation, either version 3 of the License, or
           (at your option) any later version.
           .
           This program is distributed in the hope that it will be useful,
           but WITHOUT ANY WARRANTY; without even the implied warranty of
           MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
           GNU Affero General Public License for more details.
           .
           You should have received a copy of the GNU Affero General Public License
           along with this program.  If not, see <https://www.gnu.org/licenses/>.
          EOF
          
          # Create changelog
          cat > tridui-deb/usr/share/doc/tridui/changelog << 'EOF'
          tridui (1.1.0) stable; urgency=medium
          
            * Enhanced file type detection accuracy
            * Multi-language support
            * Automatic definition updates
            * Modern UI improvements
            * Cross-platform compatibility
          
           -- JMcrafter26 <your-email@example.com>  Mon, 04 Nov 2025 00:00:00 +0000
          EOF
          gzip -9 -n tridui-deb/usr/share/doc/tridui/changelog
          
          # Create control file with extended description
          cat > tridui-deb/DEBIAN/control << 'EOF'
          Package: tridui
          Version: 1.1.0
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libgtk-3-0, libwebkit2gtk-4.1-0
          Recommends: xdg-utils
          Maintainer: JMcrafter26 <your-email@example.com>
          Homepage: https://github.com/JMcrafter26/TridUI
          Vcs-Git: https://github.com/JMcrafter26/TridUI.git
          Vcs-Browser: https://github.com/JMcrafter26/TridUI
          Description: File type identification tool with modern UI
           TrID UI is a lightweight desktop application that provides a user-friendly
           interface for TrID, a powerful tool for scanning and analyzing files.
           .
           With TrID UI, users can easily select or drop files on the Home screen to
           initiate local scans, making it convenient to detect unrecognized file types.
           The application uses a native Go implementation of the TrID file identification
           algorithm, providing fast and accurate file type detection without external
           dependencies.
           .
           Key Features:
            - Fast native Go-based file scanning
            - Accurate file type identification using TrID definitions (18,000+ types)
            - 100% local processing - no data leaves your computer
            - Modern, intuitive user interface with drag-and-drop support
            - Detailed match results with confidence scores
            - Automatic definitions updates
            - Multi-language support (10+ languages)
            - Cross-platform compatibility
          EOF
          
          # Create postinst script for icon cache update
          cat > tridui-deb/DEBIAN/postinst << 'EOF'
          #!/bin/sh
          set -e
          
          if [ "$1" = "configure" ]; then
              # Update desktop database
              if command -v update-desktop-database >/dev/null 2>&1; then
                  update-desktop-database -q /usr/share/applications || true
              fi
              
              # Update icon cache
              if command -v gtk-update-icon-cache >/dev/null 2>&1; then
                  gtk-update-icon-cache -q -t -f /usr/share/icons/hicolor || true
              fi
          fi
          
          exit 0
          EOF
          chmod 755 tridui-deb/DEBIAN/postinst
          
          # Create postrm script for cleanup
          cat > tridui-deb/DEBIAN/postrm << 'EOF'
          #!/bin/sh
          set -e
          
          if [ "$1" = "remove" ] || [ "$1" = "purge" ]; then
              # Update desktop database
              if command -v update-desktop-database >/dev/null 2>&1; then
                  update-desktop-database -q /usr/share/applications || true
              fi
              
              # Update icon cache
              if command -v gtk-update-icon-cache >/dev/null 2>&1; then
                  gtk-update-icon-cache -q -t -f /usr/share/icons/hicolor || true
              fi
          fi
          
          exit 0
          EOF
          chmod 755 tridui-deb/DEBIAN/postrm
          
          # Build .deb with compression
          fakeroot dpkg-deb --build -Zgzip tridui-deb build/bin/linux/TridUI-linux-amd64.deb

      # ARM64 build disabled - requires cross-compilation toolchain
      # To build for ARM64, use a native ARM64 runner or set up cross-compilation

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TridUI-linux
          path: build/bin/linux/*
          retention-days: 90

  combine-binaries:
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create combined zip
        run: |
          mkdir -p TridUI-v1.1.0-all-platforms
          
          # Copy Windows binaries
          if [ -d "artifacts/TridUI-windows" ]; then
            mkdir -p TridUI-v1.1.0-all-platforms/windows
            cp -r artifacts/TridUI-windows/* TridUI-v1.1.0-all-platforms/windows/
          fi
          
          # Copy macOS binaries
          if [ -d "artifacts/TridUI-macos" ]; then
            mkdir -p TridUI-v1.1.0-all-platforms/macos
            cp -r artifacts/TridUI-macos/* TridUI-v1.1.0-all-platforms/macos/
          fi
          
          # Copy Linux binaries
          if [ -d "artifacts/TridUI-linux" ]; then
            mkdir -p TridUI-v1.1.0-all-platforms/linux
            cp -r artifacts/TridUI-linux/* TridUI-v1.1.0-all-platforms/linux/
          fi
          
          # Create the combined zip
          zip -r TridUI-v1.1.0-all-platforms.zip TridUI-v1.1.0-all-platforms

      - name: Upload combined binaries
        uses: actions/upload-artifact@v4
        with:
          name: TridUI-all-platforms
          path: TridUI-v1.1.0-all-platforms.zip
          retention-days: 90
